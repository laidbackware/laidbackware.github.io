{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to MkDocs","text":"<p>This page is a collection of useful patterns and tutorials I've collected over the years.</p>"},{"location":"tkgs/set-default-psa/","title":"Set default PSA on vSphere with Tanzu 1.26+ clusters","text":"<p>From TKR 1.26 and above vSphere with Tanzu changed the default Pod Security Admission (PSA) level to enforced, meaning that each namespace must be labelled to relax the policy. The instructions on this page explain how to create a custom cluster class from the default class which sets the default PSA level to audit.</p>"},{"location":"tkgs/set-default-psa/#warning","title":"Warning","text":"<p>Taken from the vSphere with Tanzu docs.</p> <p>\"Custom ClusterClass is an experimental Kubernetes feature per the upstream Cluster API documentation. Due to the range of customizations available with custom ClusterClass, VMware cannot test or validate all possible customizations. Customers are responsible for testing, validating, and troubleshooting their custom ClusterClass clusters. Customers can open support tickets regarding their custom ClusterClass clusters, however, VMware support is limited to a best effort basis only and cannot guarantee resolution to every issue opened for custom ClusterClass clusters. Customers should be aware of these risks before deploying custom ClusterClass clusters in production environments.\"</p> <p>Given the statement above and the fact that a cluster cannot currently be switched between cluster classes, it is not recommended to use custom cluster classes.</p> <p>The procedure is based on the {vSphere docs](https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-with-tanzu-tkg/GUID-EFE7DB40-8748-42B5-9694-DBC21F9FB76A.html), which you should always reference to check for changes.</p>"},{"location":"tkgs/set-default-psa/#procedure","title":"Procedure","text":""},{"location":"tkgs/set-default-psa/#step-1-copy-the-default-clusterclass","title":"Step 1 - Copy the default ClusterClass","text":"<p>Export the variables to match your environment.</p> <pre><code>export NS=\"ns1\"\nexport CCC_NAME=\"my-cc\"\n</code></pre> <p>Export the default ClusterClass, strip unnecessary fields and update the name. <pre><code>kubectl -n $NS get clusterclass tanzukubernetescluster -o yaml &gt; ccc.yaml\nsed -i '/creationTimestamp:/d' ccc.yaml &amp;&amp; sed -i '/generation:/d' ccc.yaml &amp;&amp; \\\n sed -i '/resourceVersion:/d' ccc.yaml &amp;&amp; sed -i '/uid:/d' ccc.yaml &amp;&amp; \\\n sed -i '/resourceVersion:/d' ccc.yaml\nsed -i \"s/  name: tanzukubernetescluster/  name: ${CCC_NAME}/g\" ccc.yaml\n</code></pre></p>"},{"location":"tkgs/set-default-psa/#step-2-modify-the-custom-clusterclass","title":"Step 2 - Modify the custom ClusterClass","text":"<p>It's recommended to manually edit the file to set policy, but automated step are listed below.</p> <ul> <li>Open ccc.yaml in your favourity editor.</li> <li>Search for <code>controlPlaneFilesAdmissionConfigurationk8s126</code> and scroll up to see the <code>AdmissionConfiguration</code> template.</li> <li>Modify the yaml to set your policy by updating the section <code>plugins.0.configuration.defaults</code>. Scrolling up 30 lines will show the K8s 1.25 policy which does not enforce.</li> </ul>"},{"location":"tkgs/set-default-psa/#automated-steps-to-replace-out-the-fields-of-the-k8s-125-policy","title":"Automated steps to replace out the fields of the K8s 1.25 policy.","text":"<p>Use with caution as this was only tested with 1.26.</p> <pre><code>sed -i -E 's/enforce: \"restricted\"/warn: \"restricted\"\\n                      warn-version: \"latest\"/' ccc.yaml\nsed -i -E 's/enforce-version: \"latest\"/audit: \"restricted\"\\n                      audit-version: \"latest\"/' ccc.yaml\n</code></pre>"},{"location":"tkgs/set-default-psa/#step-3-apply-the-custom-clusterclass-to-any-namespace","title":"Step 3 - Apply the custom ClusterClass to any namespace","text":"<p>The ClusterClass to any namespaces where it is needed.</p> <pre><code>export TARGET_NS=\"ns2\"\nsed -i \"s/namespace: .*/namespace: ${TARGET_NS}/g\" ccc.yaml\nkubectl apply -f ccc.yaml\n</code></pre>"},{"location":"tkgs/set-default-psa/#step-4-create-clusters-using-the-custom-clusterclass","title":"Step 4 - Create clusters using the custom ClusterClass","text":"<p>Add the following section to your ClusterClass yamls <pre><code>spec:\n  topology:\n    class: &lt;custom cluster class name&gt;\n</code></pre></p>"}]}